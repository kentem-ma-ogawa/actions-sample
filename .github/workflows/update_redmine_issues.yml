
name: Update Redmine Issues

on:
  pull_request:
    types: [opened, closed]

env:
  SAMPLE_NUMBER: ${{ secrets.SAMPLE_NUMBER }}

jobs:
  update-redmine-issues:
    if: >
      (contains(github.head_ref, 'redmine') || contains(github.head_ref, 'bugfix'))
    runs-on: ubuntu-slim
    timeout-minutes: 5
    container: ghcr.io/pandoc/core:3.8 # ← Pandoc入りで setup不要
    steps:
      - name: Update Redmine Issues
        uses: actions/github-script@v7      
        env:
          SAMPLE_NUMBER: ${{ secrets.SAMPLE_NUMBER }}
        with:
          script: | 
            const core = require('@actions/core');
            const pr = context.payload.pull_request || {};
            const title = pr.title || '';
            // "Redmine12345…" のようなテキストからチケット番号を抽出
            const issueIds = [...title.matchAll(/Redmine\s*(\d+)/gi)]
              .map(match => match?.[1] ?? '')
              .filter(id => id != '');
            
            core.info(`issueIds: ${issueIds}`);
            if (issueIds.length <= 0) {
              core.notice('PRタイトルにチケット番号が含まれていません。');
              return;
            }

            # PR本文から <!-- Redmine: Start --> … <!-- Redmine: End --> の範囲を抽出
            const prBody  = pr.body  || '';
            const redmineFiledRegex = /<!--\s*Redmine\s*:\s*Start\s*-->([\s\S]*?)<!--\s*Redmine\s*:\s*End\s*-->/i;
            const match = prBody.match(redmineFiledRegex);
            const textForRedmine = match?.[1] ?? '';
            core.info(`Text for redmine: ${textForRedmine}`);
            
            # 抽出テキストを Pandoc で Textile へ変換し、追記用テキストを作成
            const { execFileSync } = require('child_process');

            // Pandoc 実行（GFM → Textile）
            let converted = '';
            try {
              converted = execFileSync('pandoc', [
                '--sandbox',
                '--from', 'gfm-raw_html+hard_line_breaks',
                '--to', 'textile',
                '--wrap', 'none'
              ], { input: textForRedmine, encoding: 'utf8' });
            } catch (e) {
              core.setFailed(`Markdown(GFM）→Textileへの変換に失敗: ${e.message}`);
              return;
            }
            core.info(`Converted PR text: ${converted}`);

            // UTC 日付のヘッダを付与
            const d = new Date();
            const Y = d.getUTCFullYear();
            const M = String(d.getUTCMonth() + 1).padStart(2, '0');
            const D = String(d.getUTCDate()).padStart(2, '0');
            const header = `> 【${Y}/${M}/${D}】プルリクの内容を自動記入`;

            const appendText = `${header}\n${converted}`;
            core.info(`AppendText: ${appendText}`);

            const sampleNumber = Number(process.env.SAMPLE_NUMBER || 0);
            const action = context.payload.action;
            const status = action === 'opened' ? 0 : 1;
            const author = action === 'opened' ? null : 222;

            for (const issueId of issueIds) {
              // 既存テキスト（必要ならここで Redmine API から取得して originalText に入れる）
              const originalText = '';
              const newText = originalText
                ? `${originalText}\n\n${appendText}`
                : appendText;

              // remarks（custom_fields）は appendText があれば配列を生成、なければ null
              const remarks = appendText
                ? [{ id: sampleNumber, value: newText }]
                : null;

              const issueUpdateBody = { issue: { status_id: status } };
              if (author !== null)
                issueUpdateBody.issue.assigned_to_id = author;
              if (remarks !== null) 
                issueUpdateBody.issue.custom_fields = remarks;

              core.info(`ISSUE_ID: ${issueId}`);
              core.info('issue_update_body:\n' + JSON.stringify(issueUpdateBody, null, 2));

              // 実際に Redmine API を叩く場合の例（必要ならコメントアウト解除）
              // await github.request('PUT https://your-redmine.example.com/issues/{id}.json', {
              //   id: issueId,
              //   data: body,
              //   headers: {
              //     'Content-Type': 'application/json',
              //     'X-Redmine-API-Key': process.env.REDMINE_API_KEY
              //   }
              // });
            }
