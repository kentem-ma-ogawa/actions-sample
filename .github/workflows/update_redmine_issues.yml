name: Update Redmine Issue

on:
  pull_request:
    types: [opened, closed]

env:
  SAMPLE_NUMBER: ${{ secrets.SAMPLE_NUMBER }}

jobs:
  extract_issue_ids:
    if: >
      (contains(github.head_ref, 'redmine') || contains(github.head_ref, 'bugfix'))
    runs-on: ubuntu-slim
    timeout-minutes: 1
    outputs:
      issue_ids: ${{ steps.extract.outputs.result }}
    steps:
      # PRタイトルからRedmineのissueIdを抽出
      - name: Extract Redmine Issue IDs
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request?.title || '';
            // "Redmine12345…" のようなテキストからチケット番号を抽出
            const issueIds = [...title.matchAll(/Redmine\s*(\d+)/gi)]
              .map(match => match?.[1] ?? '')
              .filter(id => id != '');
            
            if (issueIds.length <= 0) {
              core.setFailed('PRタイトルにチケット番号が含まれていないため、Redmineの更新ができませんでした。');
            }
            core.info(`issueIds: ${JSON.stringify(issueIds)}`);
            return JSON.stringify(issueIds);

  update_redmine_issues:
    needs: extract_issue_ids
    runs-on: ubuntu-slim
    timeout-minutes: 5
    steps:
      # PR本文から <!-- Redmine: Start --> … <!-- Redmine: End --> の範囲を抽出
      - name: Extract Redmine Text From PR
        id: extract_pr_text
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request?.body || '';
            const redmineFieldRegex = /<!--\s*Redmine\s*:\s*Start\s*-->([\s\S]*?)<!--\s*Redmine\s*:\s*End\s*-->/i;
            const match = body.match(redmineFieldRegex);
            const textForRedmine = match[1];

            core.info(`Text for redmine: ${textForRedmine}`);
            return textForRedmine;

      # Pandoc をセットアップ
      - name: Setup Pandoc
        uses: pandoc/actions/setup@v1
        with:
          version: 3.8
          
      # 抽出テキストを Pandoc で Textile へ変換し、追記用テキストを作成
      - name: Convert to Textile
        id: create_append_text
        if: ${{ steps.extract_pr_text.outputs.result != '' }}
        uses: actions/github-script@v7
        env:
          TEXT_FOR_REDMINE: ${{ steps.extract_pr_text.outputs.result }}
        with:
          script: |
            const { execFileSync } = require('child_process');
            const input = process.env.TEXT_FOR_REDMINE;

            // Pandoc 実行（GFM → Textile）
            let converted = '';
            try {
              converted = execFileSync('pandoc', [
                '--sandbox',
                '--from', 'gfm-raw_html+hard_line_breaks',
                '--to', 'textile',
                '--wrap', 'none'
              ], { input, encoding: 'utf8' });
            } catch (e) {
              core.setFailed(`Markdown(GFM）→ Textileへの変換に失敗: ${e.message}`);
            }
            core.info(`Converted PR text: ${converted}`);

            // 日付ヘッダーを作成
            const date = new Date();
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = (date.getDate()).toString().padStart(2, '0');
            const header = `> 【${year}/${month}/${day}】↓自動記入`;

            const newText = `${header}\n${converted}`;
            core.info(`NewText: ${newText}`);
            return newText;

      # Redmine に送る JSON を構築
      - name: Update Redmine Issues
        uses: actions/github-script@v7
        env:
          ISSUE_IDS: ${{ needs.extract_issue_ids.outputs.issue_ids }}
          APPEND_TEXT: ${{ steps.create_append_text.outputs.result }}
        with:
          script: |
            const issueIds = JSON.parse(process.env.ISSUE_IDS);
            const appendText = process.env.APPEND_TEXT || '';
            const sampleNumber = Number(process.env.SAMPLE_NUMBER);

            const action = context.payload.action;
            const status = action === 'opened' ? 0 : 1;
            const author = action === 'opened' ? null : 222;

            core.info(`issueIds: ${issueIds}`);
            for (const issueId of issueIds) {
              // 既存テキスト（必要ならここで Redmine API から取得して originalText に入れる）
              const originalText = '';
              const newText = originalText
                ? `${originalText}\n\n${appendText}`
                : appendText;

              // remarks（custom_fields）は appendText が空でなければ作成
              const remarks = appendText
                ? [{ id: sampleNumber, value: newText }]
                : null;

              const body = { issue: { status_id: status } };
              if (author !== null)
                body.issue.assigned_to_id = author;
                
              if (remarks !== null) 
                body.issue.custom_fields = remarks;

              core.info(`ISSUE_ID: ${issueId}`);
              core.info(`issue_update_body: ${JSON.stringify(body, null, 2)}`);

              // 実際に Redmine API を叩く場合の例（必要ならコメントアウト解除）
              // await github.request('PUT https://your-redmine.example.com/issues/{id}.json', {
              //   id: issueId,
              //   data: body,
              //   headers: {
              //     'Content-Type': 'application/json',
              //     'X-Redmine-API-Key': process.env.REDMINE_API_KEY
              //   }
              // });
            }
