name: Update Redmine Issue

on:
  pull_request:
    types: [opened, reopened, closed]

jobs:
  extract:
    runs-on: ubuntu-slim
    timeout-minutes: 1
    outputs:
      issue_ids: ${{ steps.extract.outputs.issue_ids }}
    steps:
    - name: Extract Redmine Issue ID
      id: extract    
      env:
        PR_TITLE: ${{ github.event.pull_request.title }}
      run: |
        ISSUE_IDS=$(echo "$PR_TITLE" | grep -oi 'Redmine[[:space:]]*[0-9]\+' | grep -o '[0-9]\+' | tr '\n' ' ')
        echo "issue_ids=$ISSUE_IDS" >> $GITHUB_OUTPUT
        
  update-redmine-issues:
    runs-on: ubuntu-slim
    timeout-minutes: 5
    needs: extract
    steps:
    - name: Update Redmine Issues     
      env:
        # 本文に「`」などの特殊文字が含まれているとエラーになるので環境変数経由で渡す
        PR_BODY: ${{ github.event.pull_request.body }}
      run: |
        for ISSUE_ID in ${{ needs.extract.outputs.issue_ids }}; do
          NEW_STATUS_ID="0"
        
          TEXT_FOR_REDMINE=$(printf '%s' "$PR_BODY" | awk '            
            /<!--[[:space:]]*Redmine[[:space:]]*:[[:space:]]*Start[[:space:]]*-->/ {flag=1; next}
            /<!--[[:space:]]*Redmine[[:space:]]*:[[:space:]]*End[[:space:]]*-->/   {flag=0}
            flag
          ')
          echo "text_for_redmine: $TEXT_FOR_REDMINE"

          # MarkdownをRedmine Textileに変換
          CONVERTED_TEXT=$(printf '%s' "$TEXT_FOR_REDMINE" | sed -E '
            # 見出し: ## Title → h2. Title
            s/^### (.+)$/h3. \1/g
            s/^## (.+)$/h2. \1/g
            s/^# (.+)$/h1. \1/g
            
            # 太字: **text** → *text*
            s/\*\*([^*]+)\*\*/\*\1\*/g
            
            # イタリック: *text* → _text_
            s/\*([^*]+)\*/_\1_/g
            
            # 取り消し線: ~~text~~ → -text-
            s/~~([^~]+)~~/-\1-/g
            
            # コード: `code` → @code@
            s/`([^`]+)`/@\1@/g
            
            # リスト: - item → * item
            s/^- /\* /g
            s/^  - /\*\* /g
            s/^    - /\*\*\* /g
            
            # 番号付きリスト: 1. item → # item
            s/^[0-9]+\. /# /g
            
            # リンク: [text](url) → "text":url
            s/\[([^\]]+)\]\(([^)]+)\)/"\1":\2/g
          ')     
          echo "Converted text: $CONVERTED_TEXT"
      
          # JSON文字列に変換
          ESCAPED_JSON_STRING=$(printf '%s' "$TEXT_FOR_REDMINE" | jq -Rs .)
          echo "escaped_json_string: $ESCAPED_JSON_STRING"
          
          if [ -n "$TEXT_FOR_REDMINE" ]; then
            issue_update_body=$(jq -n \
            --argjson status "$NEW_STATUS_ID" \
            --arg text "$TEXT_FOR_REDMINE" \
            '{
              issue: {
                status_id: $status,
                assigned_to_id: "000",
                custom_fields: [
                  { id: 111, value: $text }
                ]
              }
            }')
          else
            issue_update_body=$(jq -n \
              --argjson status "$NEW_STATUS_ID" \
              '{
                issue: {
                  status_id: $status,
                  assigned_to_id: "000"
                }
              }')
          fi
          echo "issue_update_body: $issue_update_body"
        done





