name: Update Redmine Issue

on:
  pull_request:
    types: [opened, closed] 
      
env: 
  SAMPLE_NUMBER: ${{ secrets.SAMPLE_NUMBER }}

jobs:
  extract_issue_ids:
    if: >
      (contains(github.head_ref, 'redmine') || contains(github.head_ref, 'bugfix'))
    runs-on: ubuntu-slim
    timeout-minutes: 1
    outputs:
      issue_ids: ${{ steps.extract.outputs.issue_ids }}
    steps:
    - name: Extract Redmine Issue IDs
      id: extract   
      env:
        PR_TITLE: ${{ github.event.pull_request.title }}
      run: |      
        ISSUE_IDS="$(printf '%s' "$PR_TITLE" \
          | grep -oi 'Redmine[[:space:]]*[0-9]\+' \
          | grep -o '[0-9]\+' \
          | tr '\n' ' ')"

        # ISSUE_IDSが空なら終了し、その後のstepsをスキップ 
        if [ -z "$ISSUE_IDS" ]; then
          echo "Skipping update: Not found redmine issue ids"
        fi
        echo "issue_ids=$ISSUE_IDS" >> $GITHUB_OUTPUT
    
  update_redmine_issues:
    needs: [extract_issue_ids]
    if: ${{ needs.extract_issue_ids.outputs.issue_ids != '' }}
    runs-on: ubuntu-slim
    timeout-minutes: 5
    steps:
    # PR本文からテキストを抽出する
    - name: Extract PR Text 
      id: extract_pr_text
      if: ${{ steps.extract_issue_ids.outputs.issue_ids != '' }}
      env:
        PR_BODY: ${{ github.event.pull_request.body }}
      run: |
        TEXT_FOR_REDMINE=$(printf '%s' "$PR_BODY" | awk '            
          /<!--[[:space:]]*Redmine[[:space:]]*:[[:space:]]*Start[[:space:]]*-->/ {flag=1; next}
          /<!--[[:space:]]*Redmine[[:space:]]*:[[:space:]]*End[[:space:]]*-->/   {flag=0}
          flag
        ')
        echo "Text for redmine: $TEXT_FOR_REDMINE"
        
        # 出力（複数行対応）
        {
          echo "pr_text<<EOF"
          printf '%s\n' "$TEXT_FOR_REDMINE"
          echo "EOF"
        } >> "$GITHUB_OUTPUT"

   
    # Pandocをセットアップ
    - name: Setup Pandoc
      if: ${{ steps.extract_issue_ids.outputs.issue_ids != '' }}
      uses: pandoc/actions/setup@v1
      with:
        version: 3.8
        
    #抽出したテキストをPandocでTexileに変換し、追記するテキストを作成
    - name: Convert to Textile 
      id: create_append_text
      env:
        TEXT_FOR_REDMINE: ${{ steps.extract_pr_text.outputs.pr_text }}
      if: ${{ steps.extract_issue_ids.outputs.issue_ids != '' }} &&${{ steps.extract_pr_text.outputs.pr_text != '' }}
      run: |
        CONVERTED_PR_TEXT=$(printf '%s' "$TEXT_FOR_REDMINE" \
          | pandoc --sandbox --from=gfm-raw_html+hard_line_breaks --to=textile --wrap=none)
        echo "Converted PR text: $CONVERTED_PR_TEXT"
        
        NEW_TEXT=$(printf '%s\n%s\n' \
          "> 【$(date -u +'%Y/%m/%d')】↓自動記入" \
          "$CONVERTED_PR_TEXT")

        # $GITHUB_OUTPUT へ複数行出力（ヒアドキュメント形式）
        {
          echo "new_text<<EOF"
          printf '%s\n' "$NEW_TEXT"
          echo "EOF"
        } >> "$GITHUB_OUTPUT"

    - name: Update Redmine Issues
      if: ${{ steps.extract_issue_ids.outputs.issue_ids != '' }}
      shell: bash
      env:
        APPEND_TEXT: ${{ steps.create_append_text.outputs.new_text }}
      run: |
        for ISSUE_ID in ${{ steps.extract_issue_ids.outputs.issue_ids }}; do    
          # 現在記入されているテキストを取得
          ORIGINAL_TEXT=""

          # 既存テキストと結合          
          if [[ -n "$ORIGINAL_TEXT" ]]; then
            NEW_TEXT="$ORIGINAL_TEXT"$'\n\n'"$APPEND_TEXT"
          else
            NEW_TEXT="$APPEND_TEXT"
          fi
          
          if [ "${{ github.event.action }}" = "opened" ]; then
            status=0
            author="null"
          else
            status=1
            author=222
          fi

          remarks="null"
          if [ -n "$APPEND_TEXT" ]; then
            remarks=$(jq -n \
              --arg number "$SAMPLE_NUMBER" \
              --arg text "$NEW_TEXT" \
              '[{ id: ($number | tonumber), value: $text }]')
          fi
          echo "status: $status, author: $author, remarks: $remarks"
          
          issue_update_body="$(jq -n \
            --argjson status "$status" \
            --argjson author "$author" \
            --argjson remarks "$remarks" \
            '
            .issue = {status_id: $status}
            | ( if $author != null
                then .issue += { assigned_to_id: $author }
                else .
              end )
            | ( if $remarks != null
                then .issue += { custom_fields: $remarks }
                else .
              end )
            ')"
          echo "issue_update_body: $issue_update_body"      
        done
