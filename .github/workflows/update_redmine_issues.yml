
name: Update Redmine Issue

on:
  pull_request:
    types: [opened, closed]

env:
  SAMPLE_NUMBER: ${{ secrets.SAMPLE_NUMBER }}

jobs:
  update-redmine-issues:
    runs-on: ubuntu-latest
    container: ghcr.io/pandoc/core:3.8  # ← Pandoc入りで setup不要
    timeout-minutes: 5
    if: >
      startsWith(github.head_ref, 'redmine/') || startsWith(github.head_ref, 'bugfix/')
    steps:
      - name: Extract, Convert, Update (single github-script)
        uses: actions/github-script@v7
        env:
          SAMPLE_NUMBER: ${{ secrets.SAMPLE_NUMBER }}
          # REDMINE_API_KEY: ${{ secrets.REDMINE_API_KEY }} # 実API呼び出し時のみ
        with:
          script: |
            const core = require('@actions/core');
            const { execFileSync } = require('child_process');

            // 1) 入力抽出
            const pr = context.payload.pull_request || {};
            const title = pr.title || '';
            const body  = pr.body  || '';
            const action = context.payload.action;

            const ids = [...title.matchAll(/Redmine\s*(\d+)/gi)].map(m => m[1]);
            if (ids.length === 0) {
              core.notice('No Redmine issue IDs. Skip.');
              return; // 失敗させず早期終了
            }

            const m = body.match(/<!--\s*Redmine\s*:\s*Start\s*-->([\s\S]*?)<!--\s*Redmine\s*:\s*End\s*-->/i);
            const section = m?.[1] ?? '';
            if (!section) {
              core.notice('No Redmine section in PR body. Skip.');
              return;
            }

            // 2) Pandoc変換（GFM→Textile）
            let converted;
            try {
              converted = execFileSync('pandoc', [
                '--sandbox',
                '--from', 'gfm-raw_html+hard_line_breaks',
                '--to', 'textile',
                '--wrap', 'none'
              ], { input: section, encoding: 'utf8' });
            } catch (e) {
              core.setFailed(`Conversion failed: ${e.message}`);
              return;
            }

            const d = new Date();
            const header = `> 【${d.getUTCFullYear()}/${String(d.getUTCMonth()+1).padStart(2,'0')}/${String(d.getUTCDate()).padStart(2,'0')}】↓自動記入`;
            const newText = `${header}\n${converted}`;

            // 3) Redmine更新ペイロード作成（送信は例示）
            const sampleNumber = Number(process.env.SAMPLE_NUMBER || 0);
            const status = action === 'opened' ? 0 : 1;
            const author = action === 'opened' ? null : 222;

            for (const issueId of ids) {
              const body = { issue: { status_id: status } };
              if (author !== null) body.issue.assigned_to_id = author;
              body.issue.custom_fields = [{ id: sampleNumber, value: newText }];

              core.info(`ISSUE_ID: ${issueId}`);
              core.info('issue_update_body:\n' + JSON.stringify(body, null, 2));

              // 実API呼び出し例（必要ならコメント解除）
              // await github.request('PUT https://your-redmine.example.com/issues/{id}.json', {
              //   id: issueId,
              //   data: body,
              //   headers: {
              //     'Content-Type': 'application/json',
              //     'X-Redmine-API-Key': process.env.REDMINE_API_KEY
              //   }
              // });
            }
