name: Update Redmine Issue

on:
  pull_request:
    types: [opened, closed]

env:
  SAMPLE_NUMBER: ${{ secrets.SAMPLE_NUMBER }}

jobs:
  update-redmine-issues:
    if: >
      (contains(github.head_ref, 'redmine') || contains(github.head_ref, 'bugfix'))
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      # PRの情報を事前チェック（Pandocが必要かどうか判定）
      - name: Check PR content
        id: check_content
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request?.title || '';
            const body = context.payload.pull_request?.body || '';
            
            // チケット番号の確認
            const matches = [...title.matchAll(/Redmine\s*(\d+)/gi)];
            const hasIssueIds = matches.length > 0;
            
            // Redmine範囲の確認
            const redmineFiledRegex = /<!--\s*Redmine\s*:\s*Start\s*-->([\s\S]*?)<!--\s*Redmine\s*:\s*End\s*-->/i;
            const hasRedmineText = redmineFiledRegex.test(body);
            
            core.setOutput('hasIssueIds', hasIssueIds);
            core.setOutput('needsPandoc', hasRedmineText);
            
            if (!hasIssueIds) {
              core.notice('PRタイトルにチケット番号が含まれていません。');
            }

      # Pandocを条件付きでセットアップ（テキスト変換が必要な場合のみ）
      - name: Setup Pandoc
        if: steps.check_content.outputs.needsPandoc == 'true'
        uses: pandoc/actions/setup@v1
        with:
          version: 3.8

      # メイン処理
      - name: Process PR and Update Redmine
        if: steps.check_content.outputs.hasIssueIds == 'true'
        uses: actions/github-script@v7
        env:
          SAMPLE_NUMBER: ${{ env.SAMPLE_NUMBER }}
        with:
          script: |
            const { execFileSync } = require('child_process');
            
            // ========================================
            // 1. PRタイトルからRedmineのissueIdを抽出
            // ========================================
            const title = context.payload.pull_request?.title || '';
            const matches = [...title.matchAll(/Redmine\s*(\d+)/gi)];
            const issueIds = matches.map(match => match[1]);
            
            core.info(`issueIds: ${issueIds}`);

            // ========================================
            // 2. PR本文から Redmine範囲を抽出
            // ========================================
            const body = context.payload.pull_request?.body || '';
            const redmineFiledRegex = /<!--\s*Redmine\s*:\s*Start\s*-->([\s\S]*?)<!--\s*Redmine\s*:\s*End\s*-->/i;
            const match = body.match(redmineFiledRegex);
            const textForRedmine = match ? match[1] : '';

            core.info(`Text for redmine: ${textForRedmine}`);

            // ========================================
            // 3. Textileへの変換（テキストがある場合のみ）
            // ========================================
            let newText = '';
            
            if (textForRedmine) {
              // Pandocで変換
              let converted = '';
              try {
                converted = execFileSync('pandoc', [
                  '--sandbox',
                  '--from', 'gfm-raw_html+hard_line_breaks',
                  '--to', 'textile',
                  '--wrap', 'none'
                ], { input: textForRedmine, encoding: 'utf8' });
              } catch (e) {
                core.warning(`Markdown→Textile変換に失敗: ${e.message}`);
                // 変換失敗の場合は元のテキストを使用
                converted = textForRedmine;
              }

              core.info(`Converted PR text: ${converted}`);

              // UTC日付のヘッダを付与
              const d = new Date();
              const Y = d.getUTCFullYear();
              const M = String(d.getUTCMonth() + 1).padStart(2, '0');
              const D = String(d.getUTCDate()).padStart(2, '0');
              const header = `> 【${Y}/${M}/${D}】↓自動記入`;

              newText = `${header}\n${converted}`;
              core.info(`NewText: ${newText}`);
            }

            // ========================================
            // 4. Redmine更新処理
            // ========================================
            const sampleNumber = Number(process.env.SAMPLE_NUMBER || 0);
            const action = context.payload.action;
            const status = action === 'opened' ? 0 : 1;
            const author = action === 'opened' ? null : 222;

            for (const issueId of issueIds) {
              const originalText = '';
              const finalText = originalText
                ? `${originalText}\n\n${newText}`
                : newText;

              const remarks = newText
                ? [{ id: sampleNumber, value: finalText }]
                : null;

              const body = { issue: { status_id: status } };
              if (author !== null)
                body.issue.assigned_to_id = author;
              if (remarks !== null) 
                body.issue.custom_fields = remarks;

              core.info(`ISSUE_ID: ${issueId}`);
              core.info('issue_update_body:\n' + JSON.stringify(body, null, 2));

              // 実際に Redmine API を叩く場合の例
              // await github.request('PUT https://your-redmine.example.com/issues/{id}.json', {
              //   id: issueId,
              //   data: body,
              //   headers: {
              //     'Content-Type': 'application/json',
              //     'X-Redmine-API-Key': process.env.REDMINE_API_KEY
              //   }
              // });
            }
